#!/usr/bin/ruby
require 'yaml'
require ::File.expand_path("../../lib/generators/generator_model_controller.rb", __FILE__)
require ::File.expand_path("../../lib/generators/generate_app_directory.rb", __FILE__)
require ::File.expand_path("../../lib/webit.rb", __FILE__)
module CreateApplication

  def self.error_msg(keys)
    path_error_yml = File.expand_path("../../lib/webit/error.yml", __FILE__)
    config_error = YAML.load_file("#{path_error_yml}")
    keys.split(".").inject(config_error) { |config_error, key| config_error[key] }
  end

  def self.identify_commandline_arguement
    if ARGV[0].eql? "new"
      CreateApplication.create_app
    elsif ARGV[0] == "generate" || ARGV[0] == "g"
      CreateApplication.create_model_controller
    elsif ARGV[0] == "start" && (ARGV[1] == "server" || ARGV[1] == 's')
      CreateApplication.start_server
    else
      puts "Webit Version v-0.0.1"
    end
  end

  def self.create_app
    if ARGV[1].eql? "app"
      if ARGV[2].nil?
        puts "Application Name is missing\n USAGE - webit new app APP_NAME\n"
      else
        GenerateAppDirectory.generate ARGV[2]
      end
    else
      puts "Application Name not specified\n USAGE - webit new app APP_NAME\n"
    end
  end

  def self.create_model_controller
    constant = ["model","controller"]
    if ARGV[1].nil?
      puts CreateApplication.error_msg("error.model_control_error")
    else
      type = ARGV[1].downcase
    end
    if constant.include?(type)
      if type.eql? ("model")
        if ARGV[2].nil?
          puts CreateApplication.error_msg("error.model_error")
        else
        Generator.generating_model_controller ARGV
        end
      end
      if type.eql? ("controller")
        if ARGV[2].nil?
          puts CreateApplication.error_msg("error.controller_error")
        else
          Generator.generating_model_controller ARGV
        end
      end
    else
      puts CreateApplication.error_msg("error.model_control_error")
    end
  end

  def self.start_server
    begin
      system "rackup config.ru"
    rescue
      puts "\nPlease run this command from root directory of your Application to start server!\n"
    end
  end

end

CreateApplication.identify_commandline_arguement